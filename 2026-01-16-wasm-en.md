# Running Linus Torvalds' AudioNoise Guitar Effects in the Browser via WebAssembly

I found Linus Torvalds' [AudioNoise](https://github.com/torvalds/AudioNoise) repository—a collection of guitar pedal effects written in pure C. The code is elegant: single-header implementations, clever bit manipulation for fast math, and DSP techniques I hadn't seen before.

I wanted to hear it. In a browser. Playing Bad Apple!!.

**Live Demo**: https://akihiko.shirai.as/bad-apple-html/

---

## Why WebAssembly?

### The JavaScript Limitation

Initially, I manually ported just the **phaser effect** to JavaScript. But AudioNoise has 7 effects:

| C Header | JS Port |
|----------|---------|
| phaser.h | ✓ |
| echo.h | ✗ |
| flanger.h | ✗ |
| distortion.h | ✗ |
| fm.h | ✗ |
| am.h | ✗ |
| discont.h | ✗ |

The C code uses tricks like `fastpow()` (IEEE 754 bit manipulation for fast exponentiation) that don't translate cleanly to JavaScript. Porting everything would be tedious and potentially inaccurate.

### WebAssembly Solution

- **Compile C directly** → Zero porting effort
- **Bit-perfect execution** → Same sound as native
- **Web Audio integration** → Low-latency real-time processing

---

## The Build Process

### Setting Up Emscripten

```bash
# Clone emsdk as a submodule (recommended for reproducibility)
git submodule add https://github.com/emscripten-core/emsdk.git
cd emsdk
./emsdk install latest
./emsdk activate latest
source emsdk_env.sh
```

### The C Wrapper

Created `audionoise_wasm.c` to expose all effects to JavaScript:

```c
#include <emscripten.h>
#include "phaser.h"
#include "echo.h"
#include "flanger.h"
#include "distortion.h"
// ... all effects

typedef enum {
    EFFECT_PHASER = 0,
    EFFECT_ECHO,
    EFFECT_FLANGER,
    EFFECT_DISTORTION,
    // ...
} EffectType;

EMSCRIPTEN_KEEPALIVE
void effect_init(float pot1, float pot2, float pot3, float pot4);

EMSCRIPTEN_KEEPALIVE
float effect_step(float input);

EMSCRIPTEN_KEEPALIVE
void set_effect(int effect_idx);
```

### Makefile

```makefile
EMCC_FLAGS = -O2 \
    -s WASM=1 \
    -s EXPORTED_FUNCTIONS='["_effect_init", "_effect_step", "_set_effect"]' \
    -s EXPORTED_RUNTIME_METHODS='["ccall", "cwrap"]' \
    -s MODULARIZE=1 \
    -s EXPORT_NAME="AudioNoiseModule" \
    -s SINGLE_FILE=1  # Embed Wasm as base64

audionoise_single.js: audionoise_wasm.c
    emcc $< -o $@ $(EMCC_FLAGS) -I$(AUDIONOISE_DIR)
```

The `SINGLE_FILE=1` flag embeds the Wasm binary as base64, allowing the demo to work even from `file://` URLs.

---

## JavaScript Integration

```javascript
// Load the Wasm module
const Module = await AudioNoiseModule();

// Wrap C functions
const effect_init = Module.cwrap('effect_init', null,
    ['number', 'number', 'number', 'number']);
const effect_step = Module.cwrap('effect_step', 'number', ['number']);
const set_effect = Module.cwrap('set_effect', null, ['number']);

// Initialize with pot values (0.0-1.0)
effect_init(0.3, 0.3, 0.5, 0.5);

// Process audio samples
function processAudio(e) {
    const output = e.outputBuffer.getChannelData(0);
    for (let i = 0; i < output.length; i++) {
        let sample = generateSawtooth(currentFreq);
        output[i] = effect_step(sample);  // Apply Wasm effect!
    }
}
```

---

## Gotcha: Delay Line Initialization

One bug I encountered: **flanger and echo effects weren't working**.

The original AudioNoise code in `effect.h`:

```c
static float effect_delay, target_effect_delay;

static inline void effect_set_delay(float ms) {
    target_effect_delay = ms * SAMPLES_PER_MSEC;
}
```

In the native `convert.c`, there's an `UPDATE(effect_delay)` macro called every sample to smoothly transition the delay. But in my Wasm wrapper, `effect_delay` stayed at 0!

**Fix**: Force immediate sync after initialization:

```c
static void sync_effect_delay(void) {
    extern float effect_delay, target_effect_delay;
    effect_delay = target_effect_delay;
}

// In effect_init():
case EFFECT_FLANGER:
    flanger_init(pot1, pot2, pot3, pot4);
    sync_effect_delay();  // Force delay line update
    break;
```

---

## Result

All 7 AudioNoise effects now run in the browser:
- **Phaser** - Classic sweeping sound
- **Echo** - Delay with feedback
- **Flanger** - Jet-like swoosh
- **Distortion** - Aggressive clipping
- **FM** - Frequency modulation
- **AM** - Amplitude modulation
- **Discont** - Sample discontinuity effect

Playing the "Bad Apple!!" melody with real-time effect switching.

### Pot Mapping per Effect

Each effect uses 4 potentiometers differently (designed for a physical guitar pedal):

**Guitar Effects (process input signal)**

| Effect | Pot1 | Pot2 | Pot3 | Pot4 |
|--------|------|------|------|------|
| Phaser | LFO Period [25-2000ms] | Feedback [0-75%] | Center Freq [50-880Hz] | Q [0.25-2.0] |
| Echo | Delay [0-1000ms] | - | LFO Depth [0-4ms] | Feedback [0-100%] |
| Flanger | LFO Speed [0-10Hz²] | Delay [0-4ms] | Depth [0-100%] | Feedback [0-100%] |
| Distortion | Drive [1-50x] | Tone [1-10kHz] | Level [0-100%] | Mode |
| Discont | Pitch Ratio [0.5-2.0x] | - | - | - |

**Synth Effects (ignore input, generate test tones)**

| Effect | Pot1 | Pot2 | Pot3 | Pot4 |
|--------|------|------|------|------|
| FM | Volume | Carrier [100-8100Hz] | Mod Depth [±1 oct] | Mod Freq [1-11Hz] |
| AM | Volume | Carrier [100-8100Hz] | Mod Depth | Mod Freq [1-11Hz] |

> FM/AM are test tone generators from `convert.c`. They completely ignore the input signal.

---

## Why This Matters

### WebAssembly for Audio DSP

1. **Reuse C Legacy**: 30 years of DSP libraries now run in browsers
2. **Bit-Perfect Execution**: Tricks like `fastpow()` (IEEE 754 bit manipulation) work exactly as intended
3. **Permanent Demos**: Just open a URL. No installation. No dependencies.
4. **Educational Value**: Learn Linus's code interactively

### The JSON Score Format

`bad_apple_guitar_scores.json` provides a simple, reusable format:

```json
{"f": 440.0, "d": 0.25}  // frequency (Hz), duration (seconds)
```

Useful for:
- Web Audio synthesizer demos
- Music visualization projects
- Rhythm games
- Any frequency-based playback

---

## Next Steps

- [ ] Record YouTube demo video
- [ ] Create Issue on torvalds/AudioNoise
- [ ] Effect chaining (multiple effects in series)
- [ ] Real-time MIDI input processing

---

## Links

- **Live Demo**: https://akihiko.shirai.as/bad-apple-html/
- **Source Code**: https://github.com/kaitas/bad-apple-html
- **Original AudioNoise**: https://github.com/torvalds/AudioNoise
- **Blog (Japanese)**: https://note.com/o_ob/n/nf596c20a7bc5

---

## Acknowledgments

Thanks to Linus Torvalds for the elegant AudioNoise implementation. The single-header design and clever DSP techniques made this port straightforward.

If you enjoyed this, please star the repos!
