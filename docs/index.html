<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>AudioNoise Wasm - Bad Apple!!</title>
    <style>
        :root {
            --kernel-green: #00ff41;
            --kernel-bg: #0c0c0c;
            --kernel-border: #444;
            --kernel-text: #bbbbbb;
            /* Effect colors */
            --color-phaser: #00ffff;    /* Cyan */
            --color-echo: #ff00ff;      /* Magenta */
            --color-flanger: #00ff41;   /* Green */
            --color-distortion: #ff3333; /* Red */
            --color-fm: #ff9800;        /* Orange */
            --color-am: #ffeb3b;        /* Yellow */
            --color-discont: #9c27b0;   /* Purple */
            --current-effect-color: var(--color-phaser);
        }
        body {
            background: #000;
            color: var(--kernel-text);
            font-family: "DejaVu Sans Mono", monospace;
            margin: 0;
            padding: 20px;
            font-size: 16px;
        }
        .terminal {
            max-width: 1100px;
            margin: 0 auto;
            border: 1px solid var(--kernel-border);
            background: var(--kernel-bg);
        }
        .header {
            background: #222;
            padding: 10px 15px;
            border-bottom: 1px solid #444;
            color: #888;
            font-size: 13px;
        }
        .content { padding: 25px; }
        h1 { color: var(--kernel-green); font-size: 24px; margin: 0 0 20px 0; }
        .status {
            padding: 15px;
            background: #111;
            border: 1px solid #333;
            margin-bottom: 20px;
        }
        .status.ok { border-color: var(--kernel-green); }
        .status.err { border-color: #ff5555; }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 20px;
            background: #1a1a1a;
            border: 2px solid var(--kernel-green);
            color: var(--kernel-green);
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
        }
        .btn.orange { border-color: #ffb86c; color: #ffb86c; }
        .btn:hover { background: #0a220a; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn.active { background: #0a220a; box-shadow: 0 0 10px var(--kernel-green); }
        .btn.orange.active { box-shadow: 0 0 10px #ffb86c; }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #111;
            border: 1px solid #333;
            margin-bottom: 20px;
        }
        .progress-bar .fill {
            height: 100%;
            background: var(--kernel-green);
            width: 0%;
            transition: width 0.1s;
        }
        .effect-select {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .effect-btn {
            padding: 14px 18px;
            background: #111;
            border: 1px solid #333;
            color: #888;
            font-family: inherit;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 14px;
            font-weight: bold;
        }
        .effect-btn:hover { border-color: #666; }
        .effect-btn.active { box-shadow: 0 0 10px var(--current-effect-color); }
        /* Individual effect colors */
        .effect-btn[data-effect="0"] { color: var(--color-phaser); }
        .effect-btn[data-effect="0"].active { border-color: var(--color-phaser); }
        .effect-btn[data-effect="1"] { color: var(--color-echo); }
        .effect-btn[data-effect="1"].active { border-color: var(--color-echo); }
        .effect-btn[data-effect="2"] { color: var(--color-flanger); }
        .effect-btn[data-effect="2"].active { border-color: var(--color-flanger); }
        .effect-btn[data-effect="3"] { color: var(--color-distortion); }
        .effect-btn[data-effect="3"].active { border-color: var(--color-distortion); }
        .effect-btn[data-effect="4"] { color: var(--color-fm); }
        .effect-btn[data-effect="4"].active { border-color: var(--color-fm); }
        .effect-btn[data-effect="5"] { color: var(--color-am); }
        .effect-btn[data-effect="5"].active { border-color: var(--color-am); }
        .effect-btn[data-effect="6"] { color: var(--color-discont); }
        .effect-btn[data-effect="6"].active { border-color: var(--color-discont); }
        .channels {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 12px;
            background: #080808;
            border: 1px solid #333;
        }
        .channels label {
            font-size: 13px;
            color: #888;
            cursor: pointer;
            padding: 10px 12px;
            border: 1px solid #333;
            min-width: 140px;
        }
        .channels label:hover { border-color: #666; }
        .channels input:checked + .ch-info {
            color: var(--kernel-green);
        }
        .channels input { display: none; }
        .ch-info { display: flex; flex-direction: column; gap: 2px; }
        .ch-name { font-weight: bold; font-size: 14px; }
        .ch-meta { font-size: 11px; opacity: 0.7; }
        .knobs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .knob {
            background: #080808;
            border: 1px solid #333;
            padding: 12px;
        }
        .knob label {
            display: block;
            color: #aaa;
            font-size: 11px;
            margin-bottom: 10px;
            min-height: 2.5em;
            line-height: 1.2;
        }
        .knob input { width: 100%; accent-color: var(--current-effect-color); height: 8px; }
        .knob-value { font-size: 14px; color: var(--current-effect-color); text-align: right; margin-top: 5px; }
        canvas {
            width: 100%;
            height: 120px;
            background: #000;
            border: 1px solid #222;
            margin-bottom: 20px;
        }
        .log {
            height: 120px;
            overflow-y: auto;
            background: #050505;
            border: 1px solid #222;
            padding: 10px;
            font-size: 12px;
            color: #777;
        }
        .log .ok { color: var(--kernel-green); }
        .log .err { color: #ff5555; }
        .log .warn { color: #ffb86c; }
        .info { margin-top: 20px; font-size: 12px; color: #666; }
        .info a { color: var(--kernel-green); }
        .bpm-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #080808;
            border: 1px solid #333;
        }
        .bpm-control label { color: #888; font-size: 12px; min-width: 35px; }
        .bpm-control input { flex: 1; accent-color: var(--kernel-green); }
        .bpm-control span { color: var(--kernel-green); font-size: 14px; min-width: 40px; }
        .lang-btn { min-width: 50px; font-size: 18px; }
        .effect-btn[data-tip] { position: relative; }
        .effect-btn:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a1a;
            border: 1px solid var(--kernel-green);
            padding: 12px 16px;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-line;
            max-width: 280px;
            z-index: 100;
            color: #ddd;
            text-transform: none;
            font-weight: normal;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .effect-btn.synth:hover::after {
            border-color: #ff9800;
        }
        .beat-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #666;
        }
        .beat-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #333;
            transition: all 0.05s;
        }
        .beat-dot.pulse {
            background: var(--kernel-green);
            box-shadow: 0 0 12px var(--kernel-green);
        }
        .help-section {
            margin-bottom: 15px;
        }
        .help-section summary {
            cursor: pointer;
            color: #888;
            font-size: 12px;
            padding: 8px;
            background: #080808;
            border: 1px solid #333;
        }
        .help-section summary:hover { color: var(--kernel-green); }
        .help-section[open] summary { border-bottom: none; }
        .help-table {
            background: #080808;
            border: 1px solid #333;
            border-top: none;
            padding: 10px;
            font-size: 11px;
            overflow-x: auto;
        }
        .help-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .help-table th, .help-table td {
            padding: 4px 8px;
            text-align: left;
            border-bottom: 1px solid #222;
        }
        .help-table th { color: var(--kernel-green); }
        .help-table .synth-row { color: #ff9800; }
    </style>
</head>
<body>

<div class="terminal">
    <div class="header">
        <span>[AudioNoise/wasm] Bad Apple!! with Full Effects</span>
    </div>

    <div class="content">
        <h1>AudioNoise Wasm - Bad Apple!!</h1>

        <div class="status" id="status">Loading...</div>

        <div class="controls">
            <button class="btn" id="btnStomp" disabled>STOMP</button>
            <button class="btn orange" id="btnPlay" disabled>PLAY BAD APPLE</button>
            <button class="btn" id="btnStop" disabled>STOP</button>
            <button class="btn" id="btnMute" disabled>MUTE</button>
            <button class="btn lang-btn" id="btnLang">üá¨üáß</button>
        </div>

        <div class="bpm-control">
            <label data-i18n="bpm">BPM</label>
            <input type="range" id="bpmSlider" min="50" max="200" step="1" value="200">
            <span id="bpmValue">200</span>
        </div>

        <div class="progress-bar"><div class="fill" id="progress"></div></div>
        <div class="beat-indicator">
            <span id="beatDot" class="beat-dot"></span>
            <span id="beatCount">--</span>
        </div>

        <div class="effect-select" id="effectSelect">
            <button class="effect-btn active" data-effect="0" data-i18n-title="phaser_tip">Phaser</button>
            <button class="effect-btn" data-effect="1" data-i18n-title="echo_tip">Echo</button>
            <button class="effect-btn" data-effect="2" data-i18n-title="flanger_tip">Flanger</button>
            <button class="effect-btn" data-effect="3" data-i18n-title="distortion_tip">Distortion</button>
            <button class="effect-btn" data-effect="4" data-i18n-title="fm_tip">FM</button>
            <button class="effect-btn" data-effect="5" data-i18n-title="am_tip">AM</button>
            <button class="effect-btn" data-effect="6" data-i18n-title="discont_tip">Discont</button>
        </div>

        <details class="help-section">
            <summary data-i18n="help_title">Pot Mapping Reference (click to expand)</summary>
            <div class="help-table">
                <table>
                    <tr><th>Effect</th><th>Pot1</th><th>Pot2</th><th>Pot3</th><th>Pot4</th></tr>
                    <tr style="color:var(--color-phaser)"><td>Phaser</td><td>LFO [25-2000ms]</td><td>FB [0-75%]</td><td>Freq [50-880Hz]</td><td>Q [0.25-2]</td></tr>
                    <tr style="color:var(--color-echo)"><td>Echo</td><td>Delay [0-1s]</td><td>-</td><td>LFO [0-4ms]</td><td>FB [0-100%]</td></tr>
                    <tr style="color:var(--color-flanger)"><td>Flanger</td><td>Speed [0-10Hz]</td><td>Delay [0-4ms]</td><td>Depth</td><td>FB</td></tr>
                    <tr style="color:var(--color-distortion)"><td>Distortion</td><td>Drive [1-50x]</td><td>Tone [1-10k]</td><td>Level</td><td>Mode</td></tr>
                    <tr style="color:var(--color-fm)"><td>FM *</td><td>Volume</td><td>Carrier</td><td>Mod Depth</td><td>Mod Hz</td></tr>
                    <tr style="color:var(--color-am)"><td>AM *</td><td>Volume</td><td>Carrier</td><td>Mod Depth</td><td>Mod Hz</td></tr>
                    <tr style="color:var(--color-discont)"><td>Discont</td><td>Pitch [0.5-2x]</td><td>-</td><td>-</td><td>-</td></tr>
                </table>
                <div style="margin-top:8px;color:#888;font-size:10px;">* FM/AM = Synth (test tone generators, ignore input)</div>
            </div>
        </details>

        <div class="channels" id="channelSelect">
            <!-- Populated by JavaScript -->
        </div>

        <div class="knobs">
            <div class="knob">
                <label id="pot1label">Pot1: LFO Speed</label>
                <input type="range" id="pot1" min="0" max="1" step="0.01" value="0.3">
                <div class="knob-value" id="pot1val">0.30</div>
            </div>
            <div class="knob">
                <label id="pot2label">Pot2: Feedback</label>
                <input type="range" id="pot2" min="0" max="1" step="0.01" value="0.3">
                <div class="knob-value" id="pot2val">0.30</div>
            </div>
            <div class="knob">
                <label id="pot3label">Pot3: Center Freq</label>
                <input type="range" id="pot3" min="0" max="1" step="0.01" value="0.5">
                <div class="knob-value" id="pot3val">0.50</div>
            </div>
            <div class="knob">
                <label id="pot4label">Pot4: Q (Resonance)</label>
                <input type="range" id="pot4" min="0" max="1" step="0.01" value="0.5">
                <div class="knob-value" id="pot4val">0.50</div>
            </div>
        </div>

        <canvas id="scope"></canvas>

        <div class="log" id="log"></div>

        <div class="info">
            Wasm effects from <a href="https://github.com/torvalds/AudioNoise" target="_blank">torvalds/AudioNoise</a> |
            Score from Bad Apple!! MIDI |
            <a href="simple.html">Simple JS Version (15%)</a>
        </div>
        <div class="info" style="margin-top: 10px;">
            <a href="https://github.com/kaitas/bad-apple-html" target="_blank">GitHub</a> -
            <a href="https://github.com/kaitas/bad-apple-html/stargazers" target="_blank">Star</a> &amp;
            <a href="https://github.com/kaitas/bad-apple-html/pulls" target="_blank">PRs Welcome!</a> |
            <a href="https://note.com/o_ob/n/nf596c20a7bc5" target="_blank">Blog (JA)</a> |
            <a href="https://github.com/CalvinLoke/bad-apple" target="_blank">Original Bad Apple HTML</a>
        </div>
    </div>
</div>

<script src="audionoise_single.js"></script>

<script>
// i18n „Éá„Éº„Çø
const i18n = {
    en: {
        bpm: 'BPM',
        help_title: 'Pot Mapping Reference (click to expand)',
        phaser_tip: 'üé∏ Phaser\n4-stage biquad allpass\nLFO: 32-bit phase accumulator\n"The classic 70s swoosh"\nLinus uses triangle wave LFO',
        echo_tip: 'üé∏ Echo\n65536-sample delay line (~1.3s)\nLinear interpolation for\nfractional delay reads\nPot1=delay Pot4=feedback',
        flanger_tip: 'üé∏ Flanger\n0-4ms modulated delay\nShort delay + LFO = jet sound\nPot1=speed Pot2=delay\nPot3=depth Pot4=feedback',
        distortion_tip: 'üé∏ Distortion\nsoft_clip: x/(1+|x|)\nLinus\' tanh approximation\nPot1=drive(1-50x) Pot2=tone\nPot3=level Pot4=mode',
        fm_tip: 'üî∂ FM Synth\n‚ö†Ô∏è IGNORES INPUT!\nLinus\' test tone generator\nBell-like DX7 vibes\nPot2=carrier Pot4=mod freq',
        am_tip: 'üî∂ AM Synth\n‚ö†Ô∏è IGNORES INPUT!\nLinus\' test tone generator\nClassic tremolo synthesis\nPot2=carrier Pot4=mod freq',
        discont_tip: 'üé∏ Discont\nPitch shifter with\nsin¬≤/cos¬≤ crossfade\nHides discontinuities\nPot1=0‚Üíoctave down'
    },
    ja: {
        bpm: '„ÉÜ„É≥„Éù',
        help_title: 'Pot„Éû„ÉÉ„Éî„É≥„Ç∞Êó©Ë¶ãË°®Ôºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÂ±ïÈñãÔºâ',
        phaser_tip: 'üé∏ „Éï„Çß„Ç§„Ç∂„Éº\n4ÊÆµ„Éê„Ç§„ÇØ„Ç¢„ÉÉ„Éâ„Éª„Ç™„Éº„É´„Éë„Çπ\nLFO: 32bit‰ΩçÁõ∏„Ç¢„Ç≠„É•„É†„É¨„Éº„Çø\n„Äå70Âπ¥‰ª£„ÅÆÂÆöÁï™„Çµ„Ç¶„É≥„Éâ„Äç\nLinusË£Ω„ÅÆ‰∏âËßíÊ≥¢LFO',
        echo_tip: 'üé∏ „Ç®„Ç≥„Éº\n65536„Çµ„É≥„Éó„É´ÈÅÖÂª∂Á∑ö(Á¥Ñ1.3Áßí)\nÂàÜÊï∞„Çµ„É≥„Éó„É´„ÅØÁ∑öÂΩ¢Ë£úÈñì\nPot1=ÈÅÖÂª∂ÊôÇÈñì Pot4=FB\nfastpow()„Åß„Çπ„É†„Éº„Ç∫Ê∏õË°∞',
        flanger_tip: 'üé∏ „Éï„É©„É≥„Ç∏„É£„Éº\n0-4ms Â§âË™ø„Éá„Ç£„É¨„Ç§\nÁü≠„ÅÑÈÅÖÂª∂+LFO=„Ç∏„Çß„ÉÉ„ÉàÈü≥\nPot1=ÈÄüÂ∫¶ Pot2=ÈÅÖÂª∂\nPot3=Ê∑±„Åï Pot4=FB',
        distortion_tip: 'üé∏ „Éá„Ç£„Çπ„Éà„Éº„Ç∑„Éß„É≥\nsoft_clip: x/(1+|x|)\nLinus„ÅÆtanhËøë‰ººÂÆüË£Ö\nPot1=Â¢óÂπÖ(1-50ÂÄç) Pot2=„Éà„Éº„É≥\nPot3=Âá∫Âäõ Pot4=„É¢„Éº„Éâ',
        fm_tip: 'üî∂ FM„Ç∑„É≥„Çª\n‚ö†Ô∏è ÂÖ•Âäõ„ÇíÂÆåÂÖ®ÁÑ°Ë¶ñ!\nLinus„ÅÆ„ÉÜ„Çπ„Éà„Éà„Éº„É≥ÁîüÊàêÂô®\nDX7„Å£„ÅΩ„ÅÑ„Éô„É´Èü≥\nPot2=„Ç≠„É£„É™„Ç¢ Pot4=Â§âË™øÂë®Ê≥¢Êï∞',
        am_tip: 'üî∂ AM„Ç∑„É≥„Çª\n‚ö†Ô∏è ÂÖ•Âäõ„ÇíÂÆåÂÖ®ÁÑ°Ë¶ñ!\nLinus„ÅÆ„ÉÜ„Çπ„Éà„Éà„Éº„É≥ÁîüÊàêÂô®\nÂè§ÂÖ∏ÁöÑ„Éà„É¨„É¢„É≠ÂêàÊàê\nPot2=„Ç≠„É£„É™„Ç¢ Pot4=Â§âË™øÂë®Ê≥¢Êï∞',
        discont_tip: 'üé∏ „Éá„Ç£„Çπ„Ç≥„É≥„Éà\n„Éî„ÉÉ„ÉÅ„Ç∑„Éï„Çø„Éº\nsin¬≤/cos¬≤„ÇØ„É≠„Çπ„Éï„Çß„Éº„Éâ\n‰∏çÈÄ£Á∂öÁÇπ„ÇíÈö†„ÅôÊäÄÊ≥ï\nPot1=0‚Üí1„Ç™„ÇØ„Çø„Éº„Éñ‰∏ã'
    }
};

// ÂêÑ„Ç®„Éï„Çß„ÇØ„Éà„ÅÆPot„É©„Éô„É´ (Linus„ÅÆÂÖÉ„Ç≥„Éº„Éâ„ÅÆ„Éë„É©„É°„Éº„Çø„Å´Ê∫ñÊã†)
const potLabels = {
    en: {
        phaser:     ['LFO Period', 'Feedback', 'Center Freq', 'Q'],
        echo:       ['Delay Time', '(unused)', 'LFO Depth', 'Feedback'],
        flanger:    ['LFO Speed', 'Delay', 'Depth', 'Feedback'],
        distortion: ['Drive', 'Tone', 'Level', 'Mode'],
        fm:         ['Volume', 'Carrier Hz', 'Mod Depth', 'Mod Hz'],
        am:         ['Volume', 'Carrier Hz', 'Mod Depth', 'Mod Hz'],
        discont:    ['Pitch Ratio', '(unused)', '(unused)', '(unused)']
    },
    ja: {
        phaser:     ['LFOÂë®Êúü', '„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ', '‰∏≠ÂøÉÂë®Ê≥¢Êï∞', 'QÂÄ§'],
        echo:       ['ÈÅÖÂª∂ÊôÇÈñì', '(Êú™‰ΩøÁî®)', 'LFOÊ∑±„Åï', '„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ'],
        flanger:    ['LFOÈÄüÂ∫¶', 'ÈÅÖÂª∂', 'Ê∑±„Åï', '„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ'],
        distortion: ['„Éâ„É©„Ç§„Éñ', '„Éà„Éº„É≥', 'Âá∫Âäõ', '„É¢„Éº„Éâ'],
        fm:         ['Èü≥Èáè', '„Ç≠„É£„É™„Ç¢Âë®Ê≥¢Êï∞', 'Â§âË™øÊ∑±„Åï', 'Â§âË™øÂë®Ê≥¢Êï∞'],
        am:         ['Èü≥Èáè', '„Ç≠„É£„É™„Ç¢Âë®Ê≥¢Êï∞', 'Â§âË™øÊ∑±„Åï', 'Â§âË™øÂë®Ê≥¢Êï∞'],
        discont:    ['„Éî„ÉÉ„ÉÅÊØî', '(Êú™‰ΩøÁî®)', '(Êú™‰ΩøÁî®)', '(Êú™‰ΩøÁî®)']
    }
};

// Pot„ÅÆÂÄ§„ÅÆÊÑèÂë≥ (0.0-1.0 ‚Üí ÂÆüÈöõ„ÅÆÂÄ§)
const potRanges = {
    phaser:     ['25-2000ms', '0-75%', '50-880Hz', '0.25-2.0'],
    echo:       ['0-1000ms', '-', '0-4ms', '0-100%'],
    flanger:    ['0-10Hz¬≤', '0-4ms', '0-100%', '0-100%'],
    distortion: ['1-50x', '1-10kHz', '0-100%', 'soft/hard/asym'],
    fm:         ['0-100%', '100-8100Hz', '¬±1 oct', '1-11Hz'],
    am:         ['0-100%', '100-8100Hz', '0-100%', '1-11Hz'],
    discont:    ['0.5-2.0x', '-', '-', '-']
};

let currentLang = navigator.language.startsWith('ja') ? 'ja' : 'en';

let currentEffect = 'phaser';

function updateI18n() {
    const lang = i18n[currentLang];
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        if (lang[key]) el.textContent = lang[key];
    });
    document.querySelectorAll('[data-i18n-title]').forEach(el => {
        const key = el.dataset.i18nTitle;
        if (lang[key]) el.dataset.tip = lang[key];
    });
    document.getElementById('btnLang').textContent = currentLang === 'ja' ? 'üá¨üáß' : 'üáØüáµ';
    updatePotLabels();
}

function updatePotLabels() {
    const labels = potLabels[currentLang][currentEffect];
    const ranges = potRanges[currentEffect];
    if (!labels) return;
    for (let i = 0; i < 4; i++) {
        const el = document.getElementById(`pot${i+1}label`);
        if (el) {
            const range = ranges && ranges[i] !== '-' ? ` [${ranges[i]}]` : '';
            el.textContent = `Pot${i+1}: ${labels[i]}${range}`;
        }
    }
}

const log = document.getElementById('log');
const status = document.getElementById('status');
const progress = document.getElementById('progress');
const canvas = document.getElementById('scope');
const ctx = canvas.getContext('2d');

let Module = null;
let audioCtx = null;
let scriptNode = null;
let analyser = null;
let masterGain = null;
let isPlaying = false;
let isMuted = false;
let scoreData = null;

// Wasm functions
let effect_init, effect_step, set_effect;

// Current state
let currentFreq = 0;
let currentPhase = 0;
let noteEndTime = 0;
let scoreIndex = 0;
let scoreNotes = [];
let startTime = 0;
let totalDuration = 0;
let bpmMultiplier = 138 / 200;  // BPMË™øÊï¥Áî® (default 200 BPM)
let lastNoteIndex = -1;  // „Éì„Éº„ÉàÊ§úÂá∫Áî®

function printLog(msg, type = '') {
    const div = document.createElement('div');
    if (type) div.className = type;
    div.textContent = `[${(performance.now() / 1000).toFixed(3)}] ${msg}`;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
}

// Load score JSON
async function loadScore() {
    try {
        const res = await fetch('bad_apple_guitar_scores.json');
        scoreData = await res.json();

        // Build channel checkboxes with detailed info
        const channelSelect = document.getElementById('channelSelect');
        const channels = scoreData.channels;
        const recommended = ['2', '6'];  // Lead channels with most notes

        Object.keys(channels).sort((a, b) => Number(a) - Number(b)).forEach(ch => {
            const info = channels[ch];
            const notes = info.monophonic?.highest || [];
            if (notes.length < 10) return;  // Skip channels with few notes

            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = ch;
            checkbox.checked = recommended.includes(ch);
            checkbox.addEventListener('change', updateSelectedChannels);

            // Program name (instrument)
            const program = info.program_names?.[0] || 'Unknown';
            const shortProgram = program.length > 18 ? program.slice(0, 16) + '...' : program;

            const infoDiv = document.createElement('div');
            infoDiv.className = 'ch-info';

            const nameDiv = document.createElement('div');
            nameDiv.className = 'ch-name';
            nameDiv.textContent = `CH${ch}: ${shortProgram}`;

            const metaDiv = document.createElement('div');
            metaDiv.className = 'ch-meta';
            metaDiv.textContent = `${info.note_count} notes | ${info.duration?.toFixed(1) || '?'}s`;

            infoDiv.appendChild(nameDiv);
            infoDiv.appendChild(metaDiv);
            label.appendChild(checkbox);
            label.appendChild(infoDiv);
            channelSelect.appendChild(label);
        });

        updateSelectedChannels();
        printLog(`Score loaded: ${Object.keys(channels).length} channels`, 'ok');
        return true;
    } catch (e) {
        printLog(`Score load failed: ${e.message}`, 'err');
    }
    return false;
}

// Merge notes from selected channels
function updateSelectedChannels() {
    const checkboxes = document.querySelectorAll('#channelSelect input:checked');
    const selectedChs = Array.from(checkboxes).map(cb => cb.value);

    // Collect all notes with absolute start times
    let allNotes = [];
    selectedChs.forEach(ch => {
        const info = scoreData.channels[ch];
        const notes = info?.monophonic?.highest || [];
        let time = 0;
        notes.forEach(note => {
            allNotes.push({ t: time, f: note.f, d: note.d });
            time += note.d;
        });
    });

    // Sort by start time and convert back to sequential format
    allNotes.sort((a, b) => a.t - b.t);

    // Convert to duration-based format (time between note starts)
    scoreNotes = [];
    for (let i = 0; i < allNotes.length; i++) {
        const note = allNotes[i];
        const nextTime = (i + 1 < allNotes.length) ? allNotes[i + 1].t : note.t + note.d;
        scoreNotes.push({ f: note.f, d: nextTime - note.t });
    }

    totalDuration = allNotes.length > 0 ? allNotes[allNotes.length - 1].t + allNotes[allNotes.length - 1].d : 0;
    printLog(`Channels: [${selectedChs.join(',')}] ‚Üí ${scoreNotes.length} notes, ${totalDuration.toFixed(1)}s`);
}

// Initialize Wasm
async function initWasm() {
    try {
        printLog('Loading Wasm module...');
        Module = await AudioNoiseModule();

        effect_init = Module.cwrap('effect_init', null, ['number', 'number', 'number', 'number']);
        effect_step = Module.cwrap('effect_step', 'number', ['number']);
        set_effect = Module.cwrap('set_effect', null, ['number']);

        effect_init(0.3, 0.3, 0.5, 0.5);
        printLog('Wasm loaded!', 'ok');
        return true;
    } catch (e) {
        printLog(`Wasm failed: ${e.message}`, 'err');
        return false;
    }
}

// Start audio engine
async function startAudio() {
    if (audioCtx) {
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        return true;
    }

    try {
        audioCtx = new AudioContext({ sampleRate: 48000 });

        // ScriptProcessorNode for Wasm processing (512 samples = ~10ms for tighter timing)
        scriptNode = audioCtx.createScriptProcessor(512, 0, 1);
        scriptNode.onaudioprocess = processAudio;

        masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.4;

        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;

        scriptNode.connect(masterGain);
        masterGain.connect(analyser);
        analyser.connect(audioCtx.destination);

        printLog(`Audio started: ${audioCtx.sampleRate}Hz`, 'ok');
        document.getElementById('btnStomp').classList.add('active');
        drawScope();
        return true;
    } catch (e) {
        printLog(`Audio failed: ${e.message}`, 'err');
        return false;
    }
}

// Process audio with Wasm effects
function processAudio(e) {
    const output = e.outputBuffer.getChannelData(0);
    const sampleRate = audioCtx.sampleRate;
    const now = audioCtx.currentTime;

    for (let i = 0; i < output.length; i++) {
        // Check for next note
        if (isPlaying && now >= noteEndTime && scoreIndex < scoreNotes.length) {
            const note = scoreNotes[scoreIndex];
            currentFreq = note.f;
            noteEndTime = now + note.d * bpmMultiplier;  // BPMË™øÊï¥
            scoreIndex++;

            // Update progress
            const elapsed = now - startTime;
            progress.style.width = Math.min(100, (elapsed / (totalDuration * bpmMultiplier)) * 100) + '%';

            // Beat indicator pulse (UI„Çπ„É¨„ÉÉ„Éâ„ÅßÂÆüË°å)
            if (scoreIndex !== lastNoteIndex) {
                lastNoteIndex = scoreIndex;
                const beatDot = document.getElementById('beatDot');
                const beatCount = document.getElementById('beatCount');
                beatDot.classList.add('pulse');
                beatCount.textContent = scoreIndex + '/' + scoreNotes.length;
                setTimeout(() => beatDot.classList.remove('pulse'), 80);
            }
        }

        // Generate sawtooth wave
        let sample = 0;
        if (currentFreq > 0) {
            currentPhase += currentFreq / sampleRate;
            if (currentPhase >= 1) currentPhase -= 1;
            sample = (currentPhase * 2 - 1) * 0.5; // Sawtooth -0.5 to 0.5
        }

        // Apply Wasm effect
        if (effect_step) {
            sample = effect_step(sample);
        }

        output[i] = sample;
    }

    // Check if score finished
    if (isPlaying && scoreIndex >= scoreNotes.length && now >= noteEndTime) {
        stopScore();
        printLog('Playback finished', 'ok');
    }
}

// Play score
function playScore() {
    if (!audioCtx) return;

    // ÂÖ®„ÉÅ„É£„É≥„Éç„É´„ÇíON„Å´„Åô„Çã
    document.querySelectorAll('#channelSelect input').forEach(cb => {
        cb.checked = true;
    });
    updateSelectedChannels();

    if (!scoreNotes.length) {
        printLog('No notes to play', 'warn');
        return;
    }

    scoreIndex = 0;
    currentFreq = 0;
    currentPhase = 0;
    noteEndTime = audioCtx.currentTime;
    startTime = audioCtx.currentTime;
    isPlaying = true;

    document.getElementById('btnPlay').classList.add('active');
    printLog('Playing Bad Apple!! (all channels)', 'ok');
}

// Stop score
function stopScore() {
    isPlaying = false;
    currentFreq = 0;
    scoreIndex = 0;
    lastNoteIndex = -1;
    progress.style.width = '0%';
    document.getElementById('btnPlay').classList.remove('active');
    document.getElementById('beatDot').classList.remove('pulse');
    document.getElementById('beatCount').textContent = '--';
}

// Toggle mute
function toggleMute() {
    if (!masterGain) return;
    isMuted = !isMuted;
    masterGain.gain.value = isMuted ? 0 : 0.4;
    document.getElementById('btnMute').classList.toggle('active', isMuted);
    printLog(isMuted ? 'Muted' : 'Unmuted');
}

// Draw oscilloscope
function drawScope() {
    if (!analyser) return;
    const data = new Uint8Array(analyser.frequencyBinCount);

    function draw() {
        requestAnimationFrame(draw);
        analyser.getByteTimeDomainData(data);

        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--current-effect-color');
        ctx.lineWidth = 1;
        ctx.beginPath();

        const slice = canvas.width / data.length;
        for (let i = 0; i < data.length; i++) {
            const y = (data[i] / 128) * canvas.height / 2;
            if (i === 0) ctx.moveTo(0, y);
            else ctx.lineTo(i * slice, y);
        }
        ctx.stroke();
    }
    draw();
}

// Effect selection
const effectNames = ['phaser', 'echo', 'flanger', 'distortion', 'fm', 'am', 'discont'];
const effectColors = {
    phaser: 'var(--color-phaser)',
    echo: 'var(--color-echo)',
    flanger: 'var(--color-flanger)',
    distortion: 'var(--color-distortion)',
    fm: 'var(--color-fm)',
    am: 'var(--color-am)',
    discont: 'var(--color-discont)'
};

function updateEffectColor(effectName) {
    document.documentElement.style.setProperty('--current-effect-color', effectColors[effectName]);
}

document.querySelectorAll('.effect-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.effect-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const idx = parseInt(btn.dataset.effect);
        currentEffect = effectNames[idx];
        updateEffectColor(currentEffect);
        updatePotLabels();
        if (set_effect) {
            set_effect(idx);
            printLog(`Effect: ${effectNames[idx]}`);
            updatePots();
        }
    });
});

// Pot controls
function updatePots() {
    const pots = ['pot1', 'pot2', 'pot3', 'pot4'].map(id => {
        const val = parseFloat(document.getElementById(id).value);
        document.getElementById(id + 'val').textContent = val.toFixed(2);
        return val;
    });
    if (effect_init) effect_init(...pots);
}

['pot1', 'pot2', 'pot3', 'pot4'].forEach(id => {
    document.getElementById(id).addEventListener('input', updatePots);
});

// Button handlers
document.getElementById('btnStomp').addEventListener('click', startAudio);
document.getElementById('btnPlay').addEventListener('click', playScore);
document.getElementById('btnStop').addEventListener('click', () => { stopScore(); printLog('Stopped'); });
document.getElementById('btnMute').addEventListener('click', toggleMute);

// BPM slider (138 BPM = 1.0x, range 50-200)
const bpmSlider = document.getElementById('bpmSlider');
const bpmValue = document.getElementById('bpmValue');
bpmSlider.addEventListener('input', () => {
    const bpm = parseInt(bpmSlider.value);
    bpmValue.textContent = bpm;
    bpmMultiplier = 138 / bpm;  // 138 BPM„ÅåÂéüÊõ≤„ÉÜ„É≥„Éù
    printLog(`BPM: ${bpm} (${(1/bpmMultiplier).toFixed(2)}x speed)`);
});

// Language toggle
document.getElementById('btnLang').addEventListener('click', () => {
    currentLang = currentLang === 'ja' ? 'en' : 'ja';
    updateI18n();
    printLog(`Language: ${currentLang.toUpperCase()}`);
});

// Canvas resize
function resizeCanvas() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// Initialize
(async () => {
    updateI18n();  // Ë®ÄË™ûË®≠ÂÆö„ÇíÈÅ©Áî®
    status.textContent = 'Loading...';

    const wasmOk = await initWasm();
    const scoreOk = await loadScore();

    if (wasmOk && scoreOk) {
        status.textContent = 'Ready! Click STOMP then PLAY.';
        status.classList.add('ok');
        document.getElementById('btnStomp').disabled = false;
        document.getElementById('btnPlay').disabled = false;
        document.getElementById('btnStop').disabled = false;
        document.getElementById('btnMute').disabled = false;
    } else {
        status.textContent = 'Load failed!';
        status.classList.add('err');
    }
})();
</script>

</body>
</html>
