<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>AudioNoise Wasm - Bad Apple!!</title>
    <style>
        :root {
            --kernel-green: #00ff41;
            --kernel-bg: #0c0c0c;
            --kernel-border: #444;
            --kernel-text: #bbbbbb;
        }
        body {
            background: #000;
            color: var(--kernel-text);
            font-family: "DejaVu Sans Mono", monospace;
            margin: 0;
            padding: 20px;
            font-size: 13px;
        }
        .terminal {
            max-width: 900px;
            margin: 0 auto;
            border: 1px solid var(--kernel-border);
            background: var(--kernel-bg);
        }
        .header {
            background: #222;
            padding: 8px 15px;
            border-bottom: 1px solid #444;
            color: #666;
            font-size: 11px;
        }
        .content { padding: 20px; }
        h1 { color: var(--kernel-green); font-size: 16px; margin: 0 0 20px 0; }
        .status {
            padding: 15px;
            background: #111;
            border: 1px solid #333;
            margin-bottom: 20px;
        }
        .status.ok { border-color: var(--kernel-green); }
        .status.err { border-color: #ff5555; }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 20px;
            background: #1a1a1a;
            border: 2px solid var(--kernel-green);
            color: var(--kernel-green);
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
        }
        .btn.orange { border-color: #ffb86c; color: #ffb86c; }
        .btn:hover { background: #0a220a; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn.active { background: #0a220a; box-shadow: 0 0 10px var(--kernel-green); }
        .btn.orange.active { box-shadow: 0 0 10px #ffb86c; }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #111;
            border: 1px solid #333;
            margin-bottom: 20px;
        }
        .progress-bar .fill {
            height: 100%;
            background: var(--kernel-green);
            width: 0%;
            transition: width 0.1s;
        }
        .effect-select {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .effect-btn {
            padding: 10px;
            background: #111;
            border: 1px solid #333;
            color: #888;
            font-family: inherit;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 11px;
        }
        .effect-btn:hover { border-color: #666; }
        .effect-btn.active {
            border-color: var(--kernel-green);
            color: var(--kernel-green);
        }
        .knobs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .knob {
            background: #080808;
            border: 1px solid #333;
            padding: 12px;
        }
        .knob label {
            display: block;
            color: #666;
            font-size: 10px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .knob input { width: 100%; accent-color: var(--kernel-green); }
        .knob-value { font-size: 10px; color: var(--kernel-green); text-align: right; }
        canvas {
            width: 100%;
            height: 120px;
            background: #000;
            border: 1px solid #222;
            margin-bottom: 20px;
        }
        .log {
            height: 100px;
            overflow-y: auto;
            background: #050505;
            border: 1px solid #222;
            padding: 10px;
            font-size: 11px;
            color: #666;
        }
        .log .ok { color: var(--kernel-green); }
        .log .err { color: #ff5555; }
        .log .warn { color: #ffb86c; }
        .info { margin-top: 20px; font-size: 11px; color: #555; }
        .info a { color: var(--kernel-green); }
    </style>
</head>
<body>

<div class="terminal">
    <div class="header">
        <span>[AudioNoise/wasm] Bad Apple!! with Full Effects</span>
    </div>

    <div class="content">
        <h1>AudioNoise Wasm - Bad Apple!!</h1>

        <div class="status" id="status">Loading...</div>

        <div class="controls">
            <button class="btn" id="btnStomp" disabled>STOMP</button>
            <button class="btn orange" id="btnPlay" disabled>PLAY BAD APPLE</button>
            <button class="btn" id="btnStop" disabled>STOP</button>
            <button class="btn" id="btnMute" disabled>MUTE</button>
        </div>

        <div class="progress-bar"><div class="fill" id="progress"></div></div>

        <div class="effect-select" id="effectSelect">
            <button class="effect-btn active" data-effect="0">Phaser</button>
            <button class="effect-btn" data-effect="1">Echo</button>
            <button class="effect-btn" data-effect="2">Flanger</button>
            <button class="effect-btn" data-effect="3">Distortion</button>
        </div>

        <div class="knobs">
            <div class="knob">
                <label>Pot1: Speed/Delay</label>
                <input type="range" id="pot1" min="0" max="1" step="0.01" value="0.3">
                <div class="knob-value" id="pot1val">0.30</div>
            </div>
            <div class="knob">
                <label>Pot2: Feedback</label>
                <input type="range" id="pot2" min="0" max="1" step="0.01" value="0.3">
                <div class="knob-value" id="pot2val">0.30</div>
            </div>
            <div class="knob">
                <label>Pot3: Frequency</label>
                <input type="range" id="pot3" min="0" max="1" step="0.01" value="0.5">
                <div class="knob-value" id="pot3val">0.50</div>
            </div>
            <div class="knob">
                <label>Pot4: Resonance</label>
                <input type="range" id="pot4" min="0" max="1" step="0.01" value="0.5">
                <div class="knob-value" id="pot4val">0.50</div>
            </div>
        </div>

        <canvas id="scope"></canvas>

        <div class="log" id="log"></div>

        <div class="info">
            Wasm effects from <a href="https://github.com/torvalds/AudioNoise" target="_blank">torvalds/AudioNoise</a> |
            Score from Bad Apple!! MIDI
        </div>
    </div>
</div>

<script src="audionoise_single.js"></script>

<script>
const log = document.getElementById('log');
const status = document.getElementById('status');
const progress = document.getElementById('progress');
const canvas = document.getElementById('scope');
const ctx = canvas.getContext('2d');

let Module = null;
let audioCtx = null;
let scriptNode = null;
let analyser = null;
let masterGain = null;
let isPlaying = false;
let isMuted = false;
let scoreData = null;

// Wasm functions
let effect_init, effect_step, set_effect;

// Current state
let currentFreq = 0;
let currentPhase = 0;
let noteEndTime = 0;
let scoreIndex = 0;
let scoreNotes = [];
let startTime = 0;
let totalDuration = 0;

function printLog(msg, type = '') {
    const div = document.createElement('div');
    if (type) div.className = type;
    div.textContent = `[${(performance.now() / 1000).toFixed(3)}] ${msg}`;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
}

// Load score JSON
async function loadScore() {
    try {
        const res = await fetch('bad_apple_guitar_scores.json');
        scoreData = await res.json();

        // Use channel 2 (Lead) with highest notes
        const ch = scoreData.channels['2'];
        if (ch && ch.monophonic && ch.monophonic.highest) {
            scoreNotes = ch.monophonic.highest;
            totalDuration = ch.duration;
            printLog(`Score loaded: ${scoreNotes.length} notes, ${totalDuration.toFixed(1)}s`, 'ok');
            return true;
        }
    } catch (e) {
        printLog(`Score load failed: ${e.message}`, 'err');
    }
    return false;
}

// Initialize Wasm
async function initWasm() {
    try {
        printLog('Loading Wasm module...');
        Module = await AudioNoiseModule();

        effect_init = Module.cwrap('effect_init', null, ['number', 'number', 'number', 'number']);
        effect_step = Module.cwrap('effect_step', 'number', ['number']);
        set_effect = Module.cwrap('set_effect', null, ['number']);

        effect_init(0.3, 0.3, 0.5, 0.5);
        printLog('Wasm loaded!', 'ok');
        return true;
    } catch (e) {
        printLog(`Wasm failed: ${e.message}`, 'err');
        return false;
    }
}

// Start audio engine
async function startAudio() {
    if (audioCtx) {
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        return true;
    }

    try {
        audioCtx = new AudioContext({ sampleRate: 48000 });

        // ScriptProcessorNode for Wasm processing
        scriptNode = audioCtx.createScriptProcessor(2048, 0, 1);
        scriptNode.onaudioprocess = processAudio;

        masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.4;

        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;

        scriptNode.connect(masterGain);
        masterGain.connect(analyser);
        analyser.connect(audioCtx.destination);

        printLog(`Audio started: ${audioCtx.sampleRate}Hz`, 'ok');
        document.getElementById('btnStomp').classList.add('active');
        drawScope();
        return true;
    } catch (e) {
        printLog(`Audio failed: ${e.message}`, 'err');
        return false;
    }
}

// Process audio with Wasm effects
function processAudio(e) {
    const output = e.outputBuffer.getChannelData(0);
    const sampleRate = audioCtx.sampleRate;
    const now = audioCtx.currentTime;

    for (let i = 0; i < output.length; i++) {
        // Check for next note
        if (isPlaying && now >= noteEndTime && scoreIndex < scoreNotes.length) {
            const note = scoreNotes[scoreIndex];
            currentFreq = note.f;
            noteEndTime = now + note.d;
            scoreIndex++;

            // Update progress
            const elapsed = now - startTime;
            progress.style.width = Math.min(100, (elapsed / totalDuration) * 100) + '%';
        }

        // Generate sawtooth wave
        let sample = 0;
        if (currentFreq > 0) {
            currentPhase += currentFreq / sampleRate;
            if (currentPhase >= 1) currentPhase -= 1;
            sample = (currentPhase * 2 - 1) * 0.5; // Sawtooth -0.5 to 0.5
        }

        // Apply Wasm effect
        if (effect_step) {
            sample = effect_step(sample);
        }

        output[i] = sample;
    }

    // Check if score finished
    if (isPlaying && scoreIndex >= scoreNotes.length && now >= noteEndTime) {
        stopScore();
        printLog('Playback finished', 'ok');
    }
}

// Play score
function playScore() {
    if (!audioCtx || !scoreNotes.length) return;

    scoreIndex = 0;
    currentFreq = 0;
    currentPhase = 0;
    noteEndTime = audioCtx.currentTime;
    startTime = audioCtx.currentTime;
    isPlaying = true;

    document.getElementById('btnPlay').classList.add('active');
    printLog('Playing Bad Apple!!', 'ok');
}

// Stop score
function stopScore() {
    isPlaying = false;
    currentFreq = 0;
    scoreIndex = 0;
    progress.style.width = '0%';
    document.getElementById('btnPlay').classList.remove('active');
}

// Toggle mute
function toggleMute() {
    if (!masterGain) return;
    isMuted = !isMuted;
    masterGain.gain.value = isMuted ? 0 : 0.4;
    document.getElementById('btnMute').classList.toggle('active', isMuted);
    printLog(isMuted ? 'Muted' : 'Unmuted');
}

// Draw oscilloscope
function drawScope() {
    if (!analyser) return;
    const data = new Uint8Array(analyser.frequencyBinCount);

    function draw() {
        requestAnimationFrame(draw);
        analyser.getByteTimeDomainData(data);

        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#00ff41';
        ctx.lineWidth = 1;
        ctx.beginPath();

        const slice = canvas.width / data.length;
        for (let i = 0; i < data.length; i++) {
            const y = (data[i] / 128) * canvas.height / 2;
            if (i === 0) ctx.moveTo(0, y);
            else ctx.lineTo(i * slice, y);
        }
        ctx.stroke();
    }
    draw();
}

// Effect selection
document.querySelectorAll('.effect-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.effect-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const idx = parseInt(btn.dataset.effect);
        if (set_effect) {
            set_effect(idx);
            printLog(`Effect: ${['phaser', 'echo', 'flanger', 'distortion'][idx]}`);
            updatePots();
        }
    });
});

// Pot controls
function updatePots() {
    const pots = ['pot1', 'pot2', 'pot3', 'pot4'].map(id => {
        const val = parseFloat(document.getElementById(id).value);
        document.getElementById(id + 'val').textContent = val.toFixed(2);
        return val;
    });
    if (effect_init) effect_init(...pots);
}

['pot1', 'pot2', 'pot3', 'pot4'].forEach(id => {
    document.getElementById(id).addEventListener('input', updatePots);
});

// Button handlers
document.getElementById('btnStomp').addEventListener('click', startAudio);
document.getElementById('btnPlay').addEventListener('click', playScore);
document.getElementById('btnStop').addEventListener('click', () => { stopScore(); printLog('Stopped'); });
document.getElementById('btnMute').addEventListener('click', toggleMute);

// Canvas resize
function resizeCanvas() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// Initialize
(async () => {
    status.textContent = 'Loading...';

    const wasmOk = await initWasm();
    const scoreOk = await loadScore();

    if (wasmOk && scoreOk) {
        status.textContent = 'Ready! Click STOMP then PLAY.';
        status.classList.add('ok');
        document.getElementById('btnStomp').disabled = false;
        document.getElementById('btnPlay').disabled = false;
        document.getElementById('btnStop').disabled = false;
        document.getElementById('btnMute').disabled = false;
    } else {
        status.textContent = 'Load failed!';
        status.classList.add('err');
    }
})();
</script>

</body>
</html>
